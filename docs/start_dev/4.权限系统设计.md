# 权限系统设计

## 1. 核心概念

- **用户 (User):** 系统中的个体，通过认证后获得身份。
- **角色 (Role):** 一组权限的集合，代表了用户在系统中的职责或级别。一个用户可以拥有一个或多个角色。
- **权限 (Permission):** 对特定资源或操作的授权。例如，`create_dashboard`, `view_sensitive_data`, `manage_users`。
- **资源 (Resource):** 系统中受保护的对象，如数据源、图表、仪表盘、用户、知识库文档等。

## 2. 角色定义 (示例)

| 角色 ID (Code) | 角色名称 (Display Name) | 描述                                                                 |
|----------------|-------------------------|----------------------------------------------------------------------|
| `admin`        | 系统管理员              | 拥有系统所有功能和数据的完全访问权限，包括用户管理、系统配置等。       |
| `editor`       | 内容编辑者/分析师       | 可以创建、编辑和管理其负责范围内的资源，如仪表盘、知识库、数据应用等。 |
| `viewer`       | 查看者                  | 只能查看被授权的资源，不能进行修改或创建操作。                         |
| `data_scientist`| 数据科学家             | 可以访问和分析数据，创建复杂查询和模型，但可能不具备管理权限。         |
| `free_user`    | 免费用户                | 拥有基础功能访问权限，可能有使用限制（如查询次数、模型选择等）。       |
| `paid_user`    | 付费用户                | 拥有更高级别的功能访问权限，更少的限制。                             |

## 3. 权限定义 (示例)

权限可以根据模块或资源类型进行组织。

### 3.1 通用权限

| 权限 ID (Code)             | 描述                                     |
|----------------------------|------------------------------------------|
| `view_dashboard`           | 查看仪表盘                               |
| `create_dashboard`         | 创建仪表盘                               |
| `edit_dashboard_own`       | 编辑自己创建的仪表盘                     |
| `edit_dashboard_any`       | 编辑任何仪表盘                           |
| `delete_dashboard_own`     | 删除自己创建的仪表盘                     |
| `delete_dashboard_any`     | 删除任何仪表盘                           |
| `share_dashboard`          | 分享仪表盘                               |

### 3.2 数据源管理权限

| 权限 ID (Code)             | 描述                                     |
|----------------------------|------------------------------------------|
| `view_datasource`          | 查看数据源列表                           |
| `create_datasource`        | 创建/添加新的数据源                      |
| `edit_datasource`          | 修改数据源配置                           |
| `delete_datasource`        | 删除数据源                               |
| `connect_datasource`       | 连接到数据源并执行查询                   |

### 3.3 知识库管理权限

| 权限 ID (Code)             | 描述                                     |
|----------------------------|------------------------------------------|
| `view_knowledge_base`      | 查看知识库                               |
| `create_knowledge_base`    | 创建知识库                               |
| `edit_knowledge_base_own`  | 编辑自己创建的知识库                     |
| `edit_knowledge_base_any`  | 编辑任何知识库                           |
| `upload_document_own_kb`   | 上传文档到自己创建的知识库               |
| `upload_document_any_kb`   | 上传文档到任何知识库                     |
| `delete_document_own_kb`   | 从自己的知识库删除文档                   |
| `delete_document_any_kb`   | 从任何知识库删除文档                     |

### 3.4 用户管理权限 (通常仅限 Admin)

| 权限 ID (Code)             | 描述                                     |
|----------------------------|------------------------------------------|
| `view_users`               | 查看用户列表                             |
| `create_user`              | 创建新用户                               |
| `edit_user`                | 修改用户信息                             |
| `delete_user`              | 删除用户                                 |
| `assign_roles`             | 为用户分配角色                           |

### 3.5 API/模型访问权限

| 权限 ID (Code)             | 描述                                     |
|----------------------------|------------------------------------------|
| `access_basic_llm`         | 访问基础大语言模型                       |
| `access_advanced_llm`      | 访问高级/付费大语言模型                  |
| `use_agent_chat`           | 使用智能代理聊天功能                     |
| `create_agent`             | 创建新的智能代理                         |

## 4. 角色与权限映射 (示例)

| 角色 ID        | 拥有的权限 (部分示例)                                                                                                                               |
|----------------|----------------------------------------------------------------------------------------------------------------------------------------------------|
| `admin`        | `view_dashboard`, `create_dashboard`, `edit_dashboard_any`, `delete_dashboard_any`, `view_datasource`, `create_datasource`, `edit_datasource`, `delete_datasource`, `view_users`, `create_user`, `edit_user`, `delete_user`, `assign_roles`, `access_advanced_llm` ... (所有权限) |
| `editor`       | `view_dashboard`, `create_dashboard`, `edit_dashboard_own`, `delete_dashboard_own`, `share_dashboard`, `connect_datasource`, `view_knowledge_base`, `create_knowledge_base`, `edit_knowledge_base_own`, `upload_document_own_kb`, `access_basic_llm`, `use_agent_chat` |
| `viewer`       | `view_dashboard` (可能需要特定仪表盘的共享权限), `view_knowledge_base` (共享的), `access_basic_llm` (部分功能)                                       |
| `data_scientist`| `view_dashboard`, `create_dashboard`, `edit_dashboard_own`, `view_datasource`, `connect_datasource`, `access_advanced_llm`, `use_agent_chat`                                                              |
| `free_user`    | `view_dashboard` (有限数量或公开的), `connect_datasource` (有限查询), `access_basic_llm` (有速率限制)                                                  |
| `paid_user`    | `view_dashboard`, `create_dashboard` (更多数量), `connect_datasource` (更多查询), `access_advanced_llm` (根据套餐), `use_agent_chat` (更多功能)        |

## 5. 实现注意事项

- **粒度:** 权限设计的粒度要适中。过于粗糙会导致授权不精确，过于细致会增加管理复杂度。
- **默认拒绝:** 除非明确授予权限，否则用户默认不应拥有任何权限。
- **继承:** 考虑是否需要角色继承 (例如，`高级编辑者` 继承 `编辑者` 的所有权限并增加额外权限)。
- **动态权限:** 某些权限可能依赖于上下文 (例如，用户只能编辑 *自己* 创建的文档)。这通常在代码逻辑中处理，而不仅仅是基于角色。
- **数据库设计:**
    - `users` (已有，可能需要添加 `system_role_id` 或通过关联表)
    - `roles` (id, role_name, description)
    - `permissions` (id, permission_name, resource_type, action_type, description)
    - `role_permissions` (role_id, permission_id) - 多对多
    - `user_roles` (user_id, role_id) - 多对多 (如果一个用户可以有多个角色)

---

请根据您的项目具体需求调整和扩展以上角色和权限。
